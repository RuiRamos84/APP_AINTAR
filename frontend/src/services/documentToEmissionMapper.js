// services/documentToEmissionMapper.js
// Mapeamento inteligente entre dados de documentos e vari√°veis de templates
import { getEntityByNIF } from './entityService';

/**
 * Mapeia dados de um documento para as vari√°veis de um template de emiss√£o
 * IMPORTANTE: Busca dados da ENTIDADE via NIF para preencher header (destinat√°rio oficial)
 *             e usa dados do DOCUMENTO para body (dados espec√≠ficos da interven√ß√£o)
 *
 * @param {Object} document - Dados do documento/pedido (deve conter nipc)
 * @param {Object} template - Template selecionado com metadados
 * @returns {Promise<Object>} - { recipient_data, custom_data } preenchidos
 */
export const mapDocumentToEmissionVariables = async (document, template) => {
  if (!document || !template) {
    console.warn('[DocumentMapper] Documento ou template ausente');
    return { recipient_data: {}, custom_data: {} };
  }

  // üîç BUSCAR DADOS DA ENTIDADE VIA NIF
  let entityData = null;
  if (document.nipc) {
    try {
      const response = await getEntityByNIF(document.nipc);
      if (response && response.entity) {
        entityData = response.entity;
        console.log('[DocumentMapper] Dados da entidade obtidos:', entityData.name);
      }
    } catch (error) {
      console.error('[DocumentMapper] Erro ao buscar entidade:', error);
    }
  }

  const recipient_data = {};
  const custom_data = {};

  // Campos auto-gerados (n√£o precisam de mapeamento)
  const autoGeneratedFields = [
    'NUMERO_OFICIO',
    'EMISSION_NUMBER',
    'DATA',
    'DATE',
    'DATA_EMISSAO',
    'ASSUNTO',
    'SUBJECT',
    'CODIGO_TEMPLATE'
  ];

  // ========================================
  // MAPEAMENTO SEPARADO POR SE√á√ÉO
  // ========================================

  // üìã HEADER: Dados da ENTIDADE (destinat√°rio oficial)
  const headerFieldMappings = {
    // ‚≠ê Destinat√°rio = ENTIDADE (dados oficiais cadastrados)
    'DESTINATARIO_NOME': entityData?.name || document.ts_entity || '',
    'NOME_DESTINATARIO': entityData?.name || document.ts_entity || '',
    'NOME': entityData?.name || document.ts_entity || '',

    'DESTINATARIO_MORADA': buildFullAddress(
      entityData?.address || document.address,
      entityData?.floor || document.floor,
      entityData?.door || document.door
    ),
    'MORADA_DESTINATARIO': buildFullAddress(
      entityData?.address || document.address,
      entityData?.floor || document.floor,
      entityData?.door || document.door
    ),
    'MORADA': buildFullAddress(
      entityData?.address || document.address,
      entityData?.floor || document.floor,
      entityData?.door || document.door
    ),  // ‚≠ê HEADER usa ENTIDADE com address + floor + door

    'DESTINATARIO_CODIGO_POSTAL': entityData?.postal || document.postal || '',
    'CODIGO_POSTAL_DESTINATARIO': entityData?.postal || document.postal || '',
    'CODIGO_POSTAL': entityData?.postal || document.postal || '',  // ‚≠ê HEADER usa ENTIDADE

    'DESTINATARIO_LOCALIDADE': entityData?.nut4 || document.nut4 || '',
    'LOCALIDADE_DESTINATARIO': entityData?.nut4 || document.nut4 || '',
    'LOCALIDADE': entityData?.nut4 || document.nut4 || '',  // ‚≠ê HEADER usa ENTIDADE

    'DESTINATARIO_EMAIL': entityData?.email || document.email || '',
    'EMAIL_DESTINATARIO': entityData?.email || document.email || '',
    'EMAIL': entityData?.email || document.email || '',

    // === REFER√äNCIAS DO PEDIDO (autom√°tico) ===
    'NUMERO_PEDIDO': document.regnumber || '',
    'DATA_PEDIDO': document.submission ? formatDate(document.submission) : ''

    // ‚ö†Ô∏è SUA_REFERENCIA, SUA_COMUNICACAO (refer√™ncias DO DESTINAT√ÅRIO)
    // ‚Üí N√ÉO mapeados automaticamente - devem ser preenchidos manualmente!
  };

  // üìã BODY: Dados do DOCUMENTO (interven√ß√£o espec√≠fica)
  const bodyFieldMappings = {
    // ‚≠ê REQUERENTE = ENTIDADE (pessoa que faz o pedido)
    // ts_associate √© o munic√≠pio/associado, N√ÉO o requerente!
    'NOME_REQUERENTE': entityData?.name || document.ts_entity || '',

    // NIF do requerente = NIF do documento
    'NIF': document.nipc ? String(document.nipc) : (document.nif || document.entity_nipc || ''),

    // Email pode aparecer no BODY tamb√©m
    'EMAIL': entityData?.email || document.email || '',

    // Morada de interven√ß√£o = address + floor + door
    'MORADA_INTERVENCAO': buildFullAddress(
      document.address || document.morada_intervencao,
      document.floor,
      document.door
    ),
    'MORADA': buildFullAddress(
      document.address || document.morada,
      document.floor,
      document.door
    ),

    // C√≥digo postal de interven√ß√£o = mesmo que postal
    'CODIGO_POSTAL_INTERVENCAO': document.postal || document.codigo_postal_intervencao || '',
    'CODIGO_POSTAL': document.postal || document.codigo_postal || '',

    // Localidade de interven√ß√£o = mesma que nut4
    'LOCALIDADE_INTERVENCAO': document.nut4 || document.localidade_intervencao || '',
    'LOCALIDADE': document.nut4 || document.localidade || '',

    // Prioridade: nut3 (campo real) ‚Üí fallback
    'FREGUESIA': document.nut3 || document.freguesia || '',

    // === REFER√äNCIAS DO PEDIDO (autom√°tico) ===
    'NUMERO_PEDIDO': document.regnumber || '',
    'DATA_PEDIDO': document.submission ? formatDate(document.submission) : '',

    // === OUTROS CAMPOS ===
    // Prioridade: door (campo real) ‚Üí fallback
    'PORTA': document.door || document.porta || '',
    'ANDAR': document.floor || ''

    // ‚ö†Ô∏è SUA_REFERENCIA, SUA_COMUNICACAO (refer√™ncias DO DESTINAT√ÅRIO)
    // ‚Üí N√ÉO mapeados automaticamente - devem ser preenchidos manualmente!
  };

  // ========================================
  // PROCESSAR VARI√ÅVEIS POR SE√á√ÉO
  // ========================================

  // ========================================
  // MAPEAMENTO DE NOMES DE CAMPOS
  // ========================================
  // Deve corresponder ao fieldMapping do EmissionForm.jsx para garantir consist√™ncia
  const fieldNameMapping = {
    // Destinat√°rio (header)
    'DESTINATARIO_NOME': 'destinatario_nome',
    'NOME_DESTINATARIO': 'destinatario_nome',
    'NOME': 'destinatario_nome',
    'DESTINATARIO_MORADA': 'destinatario_morada',
    'MORADA_DESTINATARIO': 'destinatario_morada',
    'DESTINATARIO_CODIGO_POSTAL': 'destinatario_codigo_postal',
    'CODIGO_POSTAL_DESTINATARIO': 'destinatario_codigo_postal',
    'DESTINATARIO_LOCALIDADE': 'destinatario_localidade',
    'LOCALIDADE_DESTINATARIO': 'destinatario_localidade',
    'DESTINATARIO_EMAIL': 'destinatario_email',
    'EMAIL_DESTINATARIO': 'destinatario_email',
    'EMAIL': 'destinatario_email',  // ‚≠ê CR√çTICO: EMAIL no header = destinatario_email

    // Requerente/Interven√ß√£o (body ‚Üí recipient_data)
    'NOME_REQUERENTE': 'nome_requerente',
    'NIF': 'nif',
    'MORADA': 'morada',
    'CODIGO_POSTAL': 'codigo_postal',
    'LOCALIDADE': 'localidade',
    'FREGUESIA': 'freguesia',
    'PORTA': 'porta',
    'MORADA_INTERVENCAO': 'morada_intervencao',
    'CODIGO_POSTAL_INTERVENCAO': 'codigo_postal_intervencao',
    'LOCALIDADE_INTERVENCAO': 'localidade_intervencao',

    // Assinatura
    'NOME_ASSINANTE': 'nome_assinante',
    'SIGNATURE_NAME': 'nome_assinante',
    'ASSINATURA_CARGO': 'assinatura_cargo',

    // Refer√™ncias (custom_data)
    'SUA_REFERENCIA': 'sua_referencia',
    'NUMERO_PEDIDO': 'numero_pedido',
    'SUA_COMUNICACAO': 'sua_comunicacao',
    'DATA_PEDIDO': 'data_pedido',
    'DATA_COMUNICACAO': 'data_comunicacao',
    'DATA_COMUNICACAO_RECEBIDA': 'data_comunicacao_recebida',
    'NOSSA_REFERENCIA': 'nossa_referencia',
    'REFERENCIA_INTERNA': 'referencia_interna',
    'REFERENCIA_DESTINATARIO': 'referencia_destinatario',

    // Template
    'CODIGO_TEMPLATE': 'codigo_template'
  };

  // 1Ô∏è‚É£ HEADER: Usar dados da ENTIDADE
  if (template.meta_data?.variaveis?.header) {
    template.meta_data.variaveis.header.forEach((variable) => {
      const varNameUpper = variable.nome.toUpperCase();

      if (autoGeneratedFields.includes(varNameUpper)) return;

      const fieldName = fieldNameMapping[varNameUpper] || variable.nome.toLowerCase();
      const mappedValue = headerFieldMappings[varNameUpper];

      if (mappedValue !== undefined) {
        custom_data[fieldName] = mappedValue;
      }
    });
  }

  // 2Ô∏è‚É£ BODY: Usar dados do DOCUMENTO
  if (template.meta_data?.variaveis?.body) {
    template.meta_data.variaveis.body.forEach((variable) => {
      const varNameUpper = variable.nome.toUpperCase();

      if (autoGeneratedFields.includes(varNameUpper)) return;

      /**
       * Determinar se√ß√£o: campos de requerente/interven√ß√£o v√£o para recipient_data
       *
       * IMPORTANTE:
       * - MORADA/CODIGO_POSTAL/LOCALIDADE/FREGUESIA do BODY = dados da INTERVEN√á√ÉO
       * - V√£o para recipient_data (n√£o custom_data)
       * - MORADA/CODIGO_POSTAL/LOCALIDADE do HEADER = dados do DESTINAT√ÅRIO
       * - V√£o para custom_data (com prefixo destinatario_)
       */
      const isRecipientField = varNameUpper.includes('REQUERENTE') ||
                               varNameUpper.includes('NIF') ||
                               varNameUpper.includes('INTERVENCAO') ||
                               varNameUpper === 'MORADA' ||
                               varNameUpper === 'CODIGO_POSTAL' ||
                               varNameUpper === 'LOCALIDADE' ||
                               varNameUpper === 'FREGUESIA' ||
                               varNameUpper === 'PORTA' ||
                               varNameUpper === 'ANDAR';

      const targetSection = isRecipientField ? recipient_data : custom_data;
      const fieldName = fieldNameMapping[varNameUpper] || variable.nome.toLowerCase();
      const mappedValue = bodyFieldMappings[varNameUpper];

      if (mappedValue !== undefined) {
        targetSection[fieldName] = mappedValue;
      }
    });
  }

  // 3Ô∏è‚É£ FOOTER: Usar dados do DOCUMENTO
  if (template.meta_data?.variaveis?.footer) {
    template.meta_data.variaveis.footer.forEach((variable) => {
      const varNameUpper = variable.nome.toUpperCase();

      if (autoGeneratedFields.includes(varNameUpper)) return;

      const fieldName = fieldNameMapping[varNameUpper] || variable.nome.toLowerCase();
      const mappedValue = bodyFieldMappings[varNameUpper];

      if (mappedValue !== undefined) {
        custom_data[fieldName] = mappedValue;
      }
    });
  }

  // Adicionar refer√™ncia ao documento original
  custom_data.source_document_pk = document.pk || null;
  custom_data.source_regnumber = document.regnumber || null;
  custom_data.notes = document.obs || document.memo || '';

  return {
    recipient_data,
    custom_data
  };
};

/**
 * Constr√≥i morada completa combinando address, floor e door
 * @param {string} address - Endere√ßo base (rua)
 * @param {string} floor - Andar
 * @param {string} door - Porta
 * @returns {string} Morada completa formatada
 */
const buildFullAddress = (address, floor, door) => {
  if (!address) return '';

  const parts = [address];

  if (floor) {
    parts.push(floor);
  }

  if (door) {
    parts.push(door);
  }

  return parts.join(', ');
};

/**
 * Formata data para formato portugu√™s
 */
const formatDate = (dateString) => {
  if (!dateString) return '';

  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;

    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();

    return `${day}-${month}-${year}`;
  } catch (error) {
    console.error('[DocumentMapper] Erro ao formatar data:', error);
    return dateString;
  }
};

/**
 * Gera assunto sugerido com base no documento
 */
export const generateSubjectFromDocument = (document) => {
  if (!document) return '';

  const parts = [];

  // Adicionar tipo de documento (tt_type √© o campo real)
  if (document.tt_type) {
    parts.push(document.tt_type);
  }

  // Adicionar n√∫mero de registo
  if (document.regnumber) {
    parts.push(`- Processo n¬∫ ${document.regnumber}`);
  }

  // ‚≠ê N√ÉO incluir associado/entidade (redundante - j√° aparece nos dados do destinat√°rio)

  return parts.join(' ') || 'Assunto da emiss√£o';
};

export default {
  mapDocumentToEmissionVariables,
  generateSubjectFromDocument
};
